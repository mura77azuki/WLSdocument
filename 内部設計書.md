# 内部設計書
## 【データベース設計】
### テーブル定義書
[テーブル定義書.pdf](pdf/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9%E6%9B%B8.pdf)を参照

---
### ER図
![ER図](img/ER%E5%9B%B3-%E4%B8%BB%E3%82%AD%E3%83%BC%E5%A4%96%E9%83%A8%E3%82%AD%E3%83%BC%E3%83%AC%E3%83%99%E3%83%AB.png)
[定義レベルER図](img/ER%E5%9B%B3-%E5%AE%9A%E7%BE%A9%E3%83%AC%E3%83%99%E3%83%AB.png)  

---
### CRUD図
※現時点では仮で作ったものを載せておきます。  
時間に余裕が有れば改めて作成します。  
[CRUD図.pdf](pdf/CRUD%E5%9B%B3.pdf)を参照

---
## 【詳細設計】
### 『ルーティング』
ミドルウェアでリファラーチェック(必要に応じて実装)  
静的ページは直接ビューに行く。  
動的ページにはコントローラーを割り当てする。  
全てのルートは名前付きルートとする。

### 『バリデーション』
必要な箇所にformRequestで実装

### 『コントローラー』
画面グループ毎にコントローラーを作成。  
各ページ名ルートと同じ名前でメソッドを作成。  
各メソッドでページに必要な情報を集めてビューに渡す。

### 『モデル』
テーブル定義書に基づいてマイグレーション作成。

### 『ビュー』
画面仕様書を元にbladeを使って作る。

---
## 【ユーザー用データのディレクトリ構成】
ディレクトリ構成イメージ  
![ディレクトリイメージ](img/%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8.png)

#### ディレクトリ関係
* 各種ハッシュ化方法などを調べる。
* 実際にハッシュ化されたディレクトリへアクセスしデータの取得ができるように実装方法を考える。
* どの値からハッシュ値を作るかも考える。

---
### 『ハッシュ値生成方法』
#### ユーザーディレクトリ名のハッシュ値
#### データファイル名のハッシュ値
#### サムネイル画像ファイル名のハッシュ値
#### ユーザーアイコン画像のファイル名のハッシュ値

---
## 【看板データ構造】
多バイト部分はビッグエンディアン  
0x12345678 = 12 34 56 78になる

### データ部の1bitずつの読み出し順
|bit位置|7|6|5|4|3|2|1|0|
|------|-|-|-|-|-|-|-|-|
|データの順番|0|1|2|3|4|5|6|7|

CRC32は将来実装用。今は全て0で埋める。  
=>現時点ではCRCが0以外である場合はエラーとする。

### データシグネチャ(仮)(必須)
|オフセット|バイト数|名称|内容|
|---|---|---|---|
|0x0000|8|signeture|"57 4C 45 44 53 49 47 4E"(WLEDSIGN)|
### ヘッダーチャンク(必須)
|オフセット|バイト数|名称|内容|
|---|---|---|---|
|0x0000|4|length|チャンクのサイズ(常に9)|
|0x0004|4|chank type|"48 45 41 44"ASCIIで"HEAD"|
|0x0008|4|width|横のドット数|
|0x000C|4|height|縦のドット数|
|0x0010|1|color_type|1:単色,2:2~3色,4:4色以上|
|0x0014|4|CRC|巡回冗長検査|
### データチャンク(必須)
|オフセット|バイト数|名称|内容|
|---|---|---|---|
|0x0000|4|length|チャンクのサイズ|
|0x0004|4|chank type|"44 41 54 41"ASCIIで"DATA"|
|0x0008|n|data|実際のデータ|
|0xXXXX|4|CRC|巡回冗長検査|
### 終端チャンク(必須)
|オフセット|バイト数|名称|内容|
|---|---|---|---|
|0x0000|4|length|チャンクのサイズ(常に0)|
|0x0004|4|chank type|"44 45 4E 44"ASCIIで"DEND"|
|0x0008|4|CRC|巡回冗長検査|

---
<!--
データ構造定義

-ファイル識別プレフィクス
-HEADER部: 識別用4文字
--size: 1byte ヘッダーのサイズ
--width: 4byte 表示データの幅（ドット数）
--height: 4byte 表示データの高さ(ドット数)
--color_set: 1byte 色の表現方法(単色,複数色,カラーパレット,フルカラー)
--compression algorithm: 1byte 圧縮方法
--animetion method: 1byte アニメーション方式

-COLOR_PALETTE部: 識別用4文字
--size: 1byte カラーパレットのサイズ
--color_num: *byte 色数

-DATA START部: 識別用4文字
--size: *byte データサイズ
--data: 実際のデータ
-DATA END部: 識別用4文字

以降のデータは無視される
-->


---
### データベース操作について
実装する機能に対して、どんな情報が必要で、どう結び付けてデータを取得していくのかをまとめる。
機能に対して不足がないように注意をする。

#### 【検索・一覧機能】
検索条件で絞り込んだ対象データについて取得するデータは何か。
看板名(パターン名)（パック名）
説明
サムネイル
作成者の表示名
付けられているタグ
お気に入りしているかどうか(ログイン時)

お気に入り操作
user_idと対象のidをお気に入りテーブルに登録。


#### 【編集機能】
新規保存・編集保存
usernameからuser_idを取得する。
テーブルへINSERT or UPDATEする。

パターン呼び出し方法
-デフォルトパック以外のパックに登録されたパターンの指定方法 
=>/packname:[任意の1文字]  
=>/packID:[任意の1文字]  
-パック登録されていないパターンの指定方法  
=>/username:[pattern_name]  
=>/patternID
* エスケープ表記の導入
パターン呼び出しの為に"/"を利用する為、文字として"/"を指定する場合は"//"のエスケープ表記を導入する必要がある。

【パック作成・アサイン機能】
* パターンパックで登録出来るパターンは統一された大きさのみになるようにする方法を考える。JSON記述で保存する

#### 【各種削除時の操作】
#### 看板削除
1. お気に入りテーブルから該当看板IDを持つデータを削除
2. 看板タグテーブルから該当看板IDを持つデータを削除
3. 看板テーブルから該当看板IDのデータを削除
#### パターン削除
1. パックアサインテーブルから該当パターンIDを持つデータを削除
2. パターンタグテーブルから該当パターンIDを持つデータを削除
3. パターンテーブルから該当パターンIDのデータを削除
#### パターンパック削除
1. パックアサインテーブルから該当パックIDを持つデータを削除
2. パターンパックテーブルから該当パターンパックIDのデータを削除
#### お気に入り解除
1. user_idとsignage_idの組み合わせが一致するデータを削除

---


---
<!--
【アイディア置き場】
* 検索にソート機能も盛り込む。
* 他の人から見たアカウントトップ=アカウントプロフィールのような表示について考える。

### 個人的課題/目標
* 現時点でcss&javascriptで描画してる結果重たくなる可能性の回避方法について検討する。  
-Canvasの利用
* サムネイルの生成方法について検討する。  
-SVGの利用  
-Canvasの利用


データ構造について、拡張時に困らないようにデータ型バージョン情報をHEADに乗せる事を検討する。
最低限必須レベルの情報はHEADに乗せるために洗い出しを行う。

HEADチャンクへの追加項目
バージョン情報(メジャー)1byte
バージョン情報(マイナー)1byte
バージョン情報(パッチ)1byte
ファイルの種類(0なら看板、1ならパターン)1byte

現時点で既に作ったデータを補完するための仕組みを作成する。
手始めに過去のデータ構造をoldバージョンとして消さずに残しておく事。
新しい構造を定義したら、バージョンの数字を更新して、変更点と移行方法を記述する事。
変更履歴として残していく。

data structure definition


その他にデータについては拡張チャンクとして定義する。
-->