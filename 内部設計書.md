# 内部設計書
## 【データベース設計】
### テーブル定義書
[テーブル定義書.pdf](pdf/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9%E6%9B%B8.pdf)を参照

---
### ER図
主キー&外部キーレベル  
![ER図](img/ER%E5%9B%B3-%E4%B8%BB%E3%82%AD%E3%83%BC%E5%A4%96%E9%83%A8%E3%82%AD%E3%83%BC%E3%83%AC%E3%83%99%E3%83%AB.png)
[定義レベルER図](img/ER%E5%9B%B3-%E5%AE%9A%E7%BE%A9%E3%83%AC%E3%83%99%E3%83%AB.png)  

---
### CRUD図
[CRUD図.pdf](pdf/CRUD%E5%9B%B3.pdf)を参照

---
## 【詳細設計】
### 『ルーティング』
ミドルウェアでリファラーチェック(必要に応じて実装)  
静的ページは直接ビューに行く。  
動的ページにはコントローラーを割り当てする。  
全てのルートは名前付きルートとする。

### 『バリデーション』
必要な箇所にformRequestで実装

### 『コントローラー』
画面グループ毎にコントローラーを作成。  
各ページ名ルートと同じ名前でメソッドを作成。  
各メソッドでページに必要な情報を集めてビューに渡す。

### 『モデル』
テーブル定義書に基づいてマイグレーション作成。

### 『ビュー』
画面仕様書を元にbladeを使って作る。

---
### 『検索・一覧機能』
看板テーブル・パターンテーブル・パターンパックテーブルを対象に表示名やタグなどで検索を行い結果を表示する  

#### ☆検索条件で絞り込んだ対象データについて取得するデータ
* 看板名|パターン名|パック名
* サムネイル

#### ☆詳細表示で以下を更に取得する
* 説明
* 作成日時
* 作成者の表示名(※1)
* 付けられているタグ(※2)
* お気に入りしているかどうか(ログイン時,看板のみ)(※3)

※1 ユーザーテーブルから取得  
※2 看板タグテーブルとタグテーブルから取得  
※3 お気に入りテーブルから取得

#### ☆お気に入り操作  
user_idと対象のidをお気に入りテーブルに登録。

#### ☆Ajax
検索条件をJSON形式で送信？  
検索結果として件数と各データを配列で返送されたJSONから取得する。  
詳細表示をする対象の種類とそのIDから追加の情報を取得して、ポップアップ上で反映して表示する。  

---
### 『表示機能』
看板データを読み込んで表示する。
看板idで看板テーブル等からデータを呼び出してJSON形式で受け取る。  

非公開設定看板の場合以下の状況では"not found"とする  
* ログインしていない
* 看板のuser_idがログインしているユーザーのidと不一致

---
### 『編集機能』
看板データ、パターンデータの編集を行う。

編集出来るデータは自分の作成したデータのみ。  
他のユーザーの看板等を参照した場合は"not found"とする  

新規作成時は看板かパターンかを選んでから作成する。  
看板編集ではパターンデータを呼び出せるがパターン編集ではパターンデータの呼び出しは出来ない。  

保存する時に以下の情報入力を行う。
* 看板名(パターン名)
* 説明
* 公開設定
* タグ

※サムネイル画像は自動で生成する。

#### ☆タグについて
1. データ保存時に指定されたタグについてタグ名でタグテーブル検索を行う
2. 
	* タグ名が存在する時  
	-> タグidと看板id(パターンid)を結び付けて看板タグ(パターンタグ)テーブルに追加
	* タグが存在しない時  
	-> 指定タグでタグテーブルに追加  
	-> タグidと看板id(パターンid)を結び付けて看板タグ(パターンタグ)テーブルに追加
3. タグの数だけ繰り返す

#### ☆データファイルの保管について
保存先とファイル名については後述のディレクトリについてを参照してください。

#### ☆外部ファイル
外部ファイル書き出し時はファイル名を入力して書き出す。  
[ファイル名].wls  
(wlsと言う拡張子が使われていないかよく調べます。)

外部ファイル読み込みではファイル構造に従ってチェックを行う。  
拡張子は極論なんでもok?  
バイナリレベルで正しければ読み込めるはず？(要検証)

#### ☆パターン呼び出し方法(考え中)  
* -デフォルトパック以外のパックに登録されたパターンの指定方法  
=>/packname:[任意の1文字]  
=>/packID:[任意の1文字]  
* -パック登録されていないパターンの指定方法  
=>/username:[pattern_name]  
=>/patternID

#### ☆エスケープ表記の導入(考え中)  
パターン呼び出しの為に"/"を利用する為、文字として"/"を指定する場合は"//"のエスケープ表記を導入する必要がある。

---
### 『パック作成・アサイン機能』
パターンパックで登録出来るパターンは統一された大きさのみになるようにする  
->登録時にパターンパックのwidth,heightとパターンのwidth,heightが一致しない場合はエラーを出す。  
パターンを登録後に編集した時におかしくならないように保存前に確認処理を行いたい。

---
### 『削除時の操作手順』
#### ☆看板削除
1. "お気に入りテーブル"から削除対象の看板IDを持つデータを削除
2. "看板タグテーブル"から削除対象の看板IDを持つデータのタグIDを取得しておく
3. "看板タグテーブル"から削除対象の看板IDを持つデータを削除する
4. 手順2で取得したタグIDが他の看板・パターンで使われているかを調べる
5. 使われていない場合は"タグテーブル"で使われていないタグIDを持つデータを削除する
6. "看板テーブル"から削除対象の看板IDのデータを削除
#### ☆パターン削除
1. "パックアサインテーブル"から削除対象のパターンIDを持つデータを削除
2. "パターンタグテーブル"から削除対象のパターンIDを持つデータのタグIDを取得しておく
3. "パターンタグテーブル"から削除対象のパターンIDを持つデータを削除する
4. 手順2で取得したタグIDが他の看板・パターンで使われているかを調べる
5. 使われていない場合は"タグテーブル"で使われていないタグIDを持つデータを削除する
6. "パターンテーブル"から削除対象のパターンIDのデータを削除
#### ☆パターンパック削除
1. "パックアサインテーブル"から削除対象のパックIDを持つデータを削除
2. "パターンパックテーブル"から削除対象のパターンパックIDのデータを削除
#### ☆お気に入り解除
1. ログインしているユーザーのIDとお気に入り解除する看板IDの組み合わせが一致するデータを削除

#### ☆ユーザー削除
1. 削除するユーザーIDを持つ看板データについて看板削除の手順を行う
2. 削除するユーザーIDを持つパターンデータについてパターン削除の手順を行う
3. 削除するユーザーIDを持つパターンパックデータについてパターンパック削除の手順を行う
4. 削除するユーザーIDを持つお気に入りデータを全て削除する
5. 意見投稿テーブルに削除するユーザーIDを持つデータがある場合、データのユーザーIDを削除して匿名投稿のデータとして扱う。

---
## 【ディレクトリ構成】
### 『ユーザー用データのディレクトリについて』
md5を利用してハッシュ値を生成してディレクトリ名やファイル名に設定する。  
生成時にそれぞれの対応するカラムに同じデータがない事を確認する。  
重複があった場合は生成をやり直す。

---
### 『ハッシュ値生成方法』
各ハッシュ値の生成方法を以下の通りに設定する。

|対象|ハッシュ値|保存先|
|---|---|---|
|ユーザーディレクトリ名|メールアドレス+処理時のunixtimeを組み合わせて生成|.../userdata/wls|
|看板データファイル名|ファイル名+処理時のunixtimeを組み合わせて生成|.../userdata/wls/[users.directory]/signage|
|パターンデータファイル名|ファイル名+処理時のunixtimeを組み合わせて生成|.../userdata/wls/[users.directory]/pattern|
|看板サムネイル画像ファイル名|wlsデータ+処理時のunixtimeを組み合わせて生成|.../userdata/thumbnail/signage|
|パターンサムネイル画像ファイル名|wlsデータ+処理時のunixtimeを組み合わせて生成|.../userdata/thumbnail/pattern|
|ユーザーアイコン画像のファイル名|サムネイル画像のデータ+処理時のunixtimeを組み合わせて生成|.../userdata/profile_img|

---
### 『ディレクトリ構成イメージ』
![ディレクトリイメージ](img/%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B82023-02-11.png)

---
### 『データ構造定義』
[データ構造定義書](data_structure/%E3%83%87%E3%83%BC%E3%82%BF%E6%A7%8B%E9%80%A0%E5%AE%9A%E7%BE%A9%E6%9B%B80_1_1.md)を参照してください。

---
## 【課題/問題点】
ボットによる新規登録や意見投稿が出来てしまいそうな状態です。  
-> reCAPTCHAを導入するなど何かしらの対策が必要と考えられる。

メールアドレスが本人の利用しているものであることを確認出来ない。  
-> 新規登録時に認証用のコードをメールで送信を行い、本人以外がメールアドレスを利用して登録することを防ぐ？

<!--
データ構造定義

-ファイル識別プレフィクス
-HEADER部: 識別用4文字
--size: 1byte ヘッダーのサイズ
--width: 4byte 表示データの幅（ドット数）
--height: 4byte 表示データの高さ(ドット数)
--color_set: 1byte 色の表現方法(単色,複数色,カラーパレット,フルカラー)
--compression algorithm: 1byte 圧縮方法
--animetion method: 1byte アニメーション方式

-COLOR_PALETTE部: 識別用4文字
--size: 1byte カラーパレットのサイズ
--color_num: *byte 色数

-DATA START部: 識別用4文字
--size: *byte データサイズ
--data: 実際のデータ
-DATA END部: 識別用4文字

以降のデータは無視される
-->

<!--
【アイディア置き場】
* 検索にソート機能も盛り込む。
* 他の人から見たアカウントトップ=アカウントプロフィールのような表示について考える。

### 個人的課題/目標
* 現時点でcss&javascriptで描画してる結果重たくなる可能性の回避方法について検討する。  
-Canvasの利用
* サムネイルの生成方法について検討する。  
-SVGの利用  
-Canvasの利用
-->